#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include "stdarg.h"
#include "stdio.h"
#include "nn_tcp.h"
#include <string.h>
#include <errno.h>
#include <time.h>

int Send(int fd, const void *buf, size_t len)
{
    int n;
    if ((n = send(fd, buf, len, 0)) < 0)
    {
        printf("send failed\n");
        return -1;
    }
    return n;
}

int Recv(int fd, void *buf, size_t len)
{
    int n;
    if ((n = recv(fd, buf, len, 0)) < 0)
    {
        printf("send failed\n");
        return -1;
    }
    return n;
}

int open_server_socket(char *my_ip, char *server_ip, int port)
{
    int server_sock;
    struct sockaddr_in my_addr;
    struct sockaddr_in serveraddr;

    if ((server_sock = socket(AF_INET, SOCK_STREAM, 0)) < 0)
    {
        return -1;
    }

    bzero((char *)&my_addr, sizeof(my_addr));
    my_addr.sin_family = AF_INET;
    inet_aton(my_ip, &(my_addr.sin_addr));
    my_addr.sin_port = 0;
    if (bind(server_sock, (struct sockaddr *)&my_addr, sizeof(my_addr)) < 0)
    {
        printf("open_server_socket: binding failiure: %s\n", strerror(errno));
        return -1;
    }

    bzero((char *) &serveraddr, sizeof(serveraddr));
    serveraddr.sin_family = AF_INET; 
    inet_pton(AF_INET, server_ip, &(serveraddr.sin_addr)); 
    serveraddr.sin_port = htons((unsigned short)port); 
    if (connect(server_sock, (struct sockaddr *)&serveraddr, sizeof(serveraddr)) < 0)
    {
        printf("open_server_socket: connect failed\n");
        return -1;
    }
    return server_sock;
}

void get_senone_scores(float *feat, int n_feats
                        int16_t *scores, int n_scores, 
                        char *model_name){
    int model_name_len = strlen(model_name);
    int packet_len = model_name_len+(n_feats*4);
    int server_sock = open_server_socket("127.0.0.1","0.0.0.0",9000);
    Send(server_sock,&packet_len,4);
    Send(server_sock,model_name,strlen(model_name));
    Send(server_sock,feat_buf_cd,n_feats*4);
    Recv(server_sock,score_buf,n_scores*2);
}

int main(){
	int16_t score_buf[4138];
	float feat_buf_ci[225] = 
        {6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734,
        6.1011, 15.073, 24.552, 38.234, 
            46.479, 67.203, 72.336, 76.193, 81.123,
            84.127, 87.706, 92.844, 90.843, 8.5409,
            8.911, 8.7754, 9.5856, 9.9425, 8.9031,
            8.2862, 9.1008, 9.8002, 9.8057, 9.9796,8.9734};
    float feat_buf_cd[440] = {
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
        6.9151, 16.056, 26.185, 28.527, 43.916, 53.126, 67.823, 
            63.852, 69.756, 96.275, 90.811, 88.143, 91.802, 7.4605 ,
            7.2699, 7.1905, 7.1041, 7.3749, 7.1837, 7.6972, 7.6366 ,
            8.7424, 9.1094, 9.1466, 8.5187, 9.0736, 9.4671, 10.006 ,
            9.7616, 8.735 ,8.5308 ,8.0986 ,9.0503 ,9.6044, 9.93 ,
            9.684, 10.218, 9.6032, 8.9658, 8.4401,
    };
	char* model_name = "mlp4-2x2560-cd-adam-bn-drop-conv-noshort_CP.h5\r\n";
    int model_name_len = strlen(model_name);
    int packet_len = model_name_len+(440*4);
	int server_sock = open_server_socket("127.0.0.1","0.0.0.0",9000);
    printf("%d\n", model_name_len);
    Send(server_sock,&packet_len,4);
	Send(server_sock,model_name,strlen(model_name));
	Send(server_sock,feat_buf_cd,440*4);
	Recv(server_sock,score_buf,4138*2);
    time_t mytime;
    printf("%lu\n", (unsigned long)time(NULL)); 
	printf("%d\n", score_buf[4137]);
}